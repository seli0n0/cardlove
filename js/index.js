/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */

document.addEventListener('deviceready', onDeviceReady, false);

function onDeviceReady() {
    console.log('Running cordova-' + cordova.platformId + '@' + cordova.version);
    document.getElementById('deviceready').classList.add('ready');
}

// База вопросов
const questions = [
    "Какой твой идеальный вечер вдвоём?",
    "Что тебе нравится во мне больше всего?",
    "Какое свидание тебе запомнилось на всю жизнь?",
    "Какой самый нелепый комплимент тебе делали?",
    "Ты веришь в любовь с первого взгляда?",
    "Что в отношениях для тебя важнее: страсть или надёжность?",
    "Какой фильм о любви тебе нравится?",
    "Что для тебя значит 'настоящая любовь'?",
    "Можно ли любить двух людей одновременно?",
    "Что тебя бесит в отношениях, но ты терпишь?",
    "Как ты понимаешь слово 'верность'?",
    "Бывало ли, что ты ревновал(а) без причины?",
    "Что бы ты изменил(а) в наших отношениях?",
    "Как ты переживаешь конфликты в паре?",
    "Если бы наше первое свидание было фильмом, как бы он назывался?",
    "Какой самый странный подарок ты получал(а)?",
    "Как бы ты описал(а) наши отношения в одном слове?",
    "Если бы мы застряли в лифте, чем бы занялись?",
    "Какой суперсилой должна обладать идеальная пара?",
    "Может ли дружба быть крепче любви?",
    "Любовь — это чувство или выбор?",
    "Нужно ли сохранять отношения 'ради детей'?",
    "Можно ли простить измену?",
    "Что важнее в браке: любовь или уважение?",
    "Когда ты в последний раз чувствовал(а) бабочек в животе?",
    "Какая наша совместная мечта?",
    "Какой момент вместе ты хотел(а) бы прожить заново?",
    "Что бы ты написала мне в любовном письме?",
    "Где бы ты хотел(а) провести старость?",
    "Какой твой идеальный вечер вдвоём?",
"Что тебе нравится во мне больше всего?",
"Какое свидание тебе запомнилось на всю жизнь?",
"Когда ты впервые понял(а), что влюблён(а)?",
"Какой наш совместный момент ты считаешь самым романтичным?",
"Что в отношениях делает тебя по-настоящему счастливым(ой)?",
"Какой самый неожиданный комплимент ты получал(а)?",
"Где бы ты хотел(а) провести наш юбилей?",
"Какой подарок от меня тебя больше всего тронул?",
"Что в моих глазах тебя завораживает?",
"Какой наш поцелуй запомнился тебе больше всего?",
"Что бы ты хотел(а) повторить из нашего совместного прошлого?",
"Какое признание в любви тебе запомнилось больше всего?",
"Какой момент вместе ты хотел(а) бы запечатлеть навсегда?",
"Что в наших отношениях тебя удивило больше всего?",
"Какой фильм о любви тебе ближе всего?",
"Какой наш совместный ритуал тебе дороже всего?",
"Что в моём характере тебя больше всего привлекает?",
"Какой город показался тебе самым романтичным?",
"Что в отношениях ты считаешь проявлением настоящей любви?",
"Какой наш дуэт в песнях тебе нравится больше всего?",
"Что в моих прикосновениях тебе нравится больше всего?",
"Какой момент из нашей истории ты считаешь переломным?",
"Что в нашей паре делает тебя счастливым(ой)?",
"Как бы ты описал(а) нашу любовь в трёх словах?",
"Что для тебя значит 'настоящая любовь'?",
"Можно ли любить двух людей одновременно?",
"Как ты понимаешь слово 'верность'?",
"Что важнее в браке: любовь или уважение?",
"Можно ли простить измену?",
"Нужно ли сохранять отношения 'ради детей'?",
"Любовь — это чувство или выбор?",
"Может ли дружба быть крепче любви?",
"Что тебя бесит в отношениях, но ты терпишь?",
"Бывало ли, что ты ревновал(а) без причины?",
"Что бы ты изменил(а) в наших отношениях?",
"Как ты переживаешь конфликты в паре?",
"Что для тебя важнее: страсть или стабильность?",
"Как ты относишься к открытым отношениям?",
"Может ли любовь длиться вечно?",
"Что для тебя неприемлемо в отношениях?",
"Как ты представляешь идеальные отношения?",
"Что для тебя важнее: слова или поступки?",
"Можно ли построить счастье на лжи?",
"Как ты относишься к браку?",
"Что для тебя сложнее: прощать или просить прощения?",
"Как ты понимаешь фразу 'быть одним целым'?",
"Что для тебя значит 'доверие' в отношениях?",
"Как ты относишься к роликам про отношения в соцсетях?",
"Что для тебя важнее: любовь или свобода?",
"Что тебя больше всего возбуждает в наших отношениях?",
"Какой наш интимный момент тебе запомнился больше всего?",
"Что бы ты хотел(а) попробовать в нашей интимной жизни?",
"Какой мой наряд тебя больше всего возбуждает?",
"Что в нашей близости тебя удивило больше всего?",
"Какой момент интимной близости ты считаешь идеальным?",
"Что тебе нравится в моих прикосновениях?",
"Какой запах тебя возбуждает?",
"Что для тебя значит 'страсть' в отношениях?",
"Какую эрогенную зону я ещё не открыл(а)?",
"Что тебя заводит больше всего?",
"Какой наш эксперимент в постели тебе запомнился?",
"Что для тебя важнее: нежность или страсть?",
"Какой момент близости ты хотел(а) бы повторить?",
"Что делает нашу интимную жизнь особенной?",
"Где бы ты хотел(а) провести старость?",
"Какая наша совместная мечта?",
"Как ты представляешь наш идеальный отпуск?",
"Какой момент вместе ты хотел(а) бы прожить заново?",
"Что бы ты хотел(а) изменить в нашем будущем?",
"Как ты представляешь наш дом мечты?",
"Какое совместное приключение ты хотел(а) бы испытать?",
"Какой навык ты хотел(а) бы освоить вместе?",
"Какой семейной традиции ты хотел(а) бы придерживаться?",
"Где ты видишь нас через 10 лет?",
"Какой совместный проект ты хотел(а) бы реализовать?",
"Какой праздник ты хотел(а) бы отмечать по-особенному?",
"Какое место в мире ты хотел(а) бы показать мне?",
"Какой подарок ты мечтаешь сделать мне?",
"Как ты представляешь наш идеальный выходной?",
"Какое мое качество тебя удивляет больше всего?",
"Какой мой поступок показал тебе мой настоящий характер?",
"В какой момент ты увидел(а) мою истинную сущность?",
"Какая часть моего тела тебе нравится больше всего?",
"Какой мой навык тебя впечатлил?",
"Когда ты почувствовал(а), что действительно меня понимаешь?",
"Какая моя слабость тебя трогает?",
"Какой мой неочевидный талант тебя удивил?",
"Какое мое детское воспоминание тебе запомнилось?",
"Какой мой жизненный принцип тебе близок?",
"Какая моя привычка тебя забавляет?",
"Когда ты почувствовал(а), что можешь быть самим(ой) собой со мной?",
"Какое мое выражение лица тебе нравится больше всего?",
"Какой мой недостаток ты считаешь милым?",
"Какая моя черта характера тебя вдохновляет?",
"Какой момент показал тебе мою силу духа?",
"Какое мое умение тебя поразило?",
"Когда ты понял(а), что мы похожи?",
"Какая моя сторона личности тебя удивляет?",
"Какой мой смешной страх тебе известен?",
"Какое мое качество ты считаешь самым ценным?",
"Когда ты увидел(а) меня по-настоящему уязвимым(ой)?",
"Какая моя детская мечта тебя тронула?",
"Какой мой неожиданный навык тебя впечатлил?",
"Какое мое решение вызвало у тебя уважение?",
"Когда ты почувствовал(а), что мы на одной волне?",
"Какая моя странность тебе нравится?",
"Какой мой поступок показал тебе мою щедрость души?",
"Какая история из моего прошлого тебя поразила?",
"Когда ты понял(а), что я особенный(ая)?",
"Как ты понял(а), что влюблен(а)?",
"Какое чувство ты испытываешь, когда я смотрю на тебя?",
"Когда ты почувствовал(а) нашу эмоциональную связь?",
"Какой момент показал тебе глубину моих чувств?",
"Что в наших отношениях вызывает у тебя благодарность?",
"Когда ты почувствовал(а), что можешь мне доверять?",
"Какое чувство ты испытываешь, когда мы молчим вместе?",
"Какой наш взгляд друг на друга был самым выразительным?",
"Когда ты почувствовал(а) нашу духовную близость?",
"Что вызывает у тебя трепет в наших отношениях?",
"Какой момент показал тебе мою преданность?",
"Когда ты почувствовал(а), что мы созданы друг для друга?",
"Какое чувство ты испытываешь, когда я тебя обнимаю?",
"Какой наш разговор тронул тебя больше всего?",
"Когда ты осознал(а) силу нашей связи?",
"Что вызывает у тебя чувство защищенности со мной?",
"Какой момент показал тебе мою готовность быть с тобой?",
"Когда ты почувствовал(а), что мы - команда?",
"Какое чувство ты испытываешь, когда мы преодолеваем трудности?",
"Какой наш совместный успех тебя больше всего обрадовал?",
"Когда ты почувствовал(а), что можешь на меня положиться?",
"Что вызывает у тебя чувство гордости за наши отношения?",
"Какой момент показал тебе мою чуткость?",
"Когда ты почувствовал(а) наше невербальное понимание?",
"Какое чувство ты испытываешь, когда мы вместе смеемся?",
"Какой наш душевный разговор запомнился тебе больше всего?",
"Когда ты осознал(а), что мы дополняем друг друга?",
"Что вызывает у тебя чувство тепла в наших отношениях?",
"Какой момент показал тебе мою способность любить?",
"Когда ты почувствовал(а), что мы становимся ближе?",
"Какая наша безумная идея может стать реальностью?",
"Какой наш фантастический сценарий тебя заводит?",
"Какое неожиданное место ты хотел(а) бы со мной посетить?",
"Какой наш смелый поступок мог бы нас прославить?",
"Какое необычное хобби мы могли бы освоить вместе?",
"Какой наш творческий проект мог бы изменить мир?",
"Какое рискованное приключение нас могло бы сблизить?",
"Какой нестандартный подарок ты хотел(а) бы мне сделать?",
"Какое неожиданное умение мы могли бы освоить?",
"Какой наш совместный бизнес мог бы стать успешным?",
"Какое экстремальное испытание мы могли бы пройти?",
"Какой необычный дом ты хотел(а) бы для нас?",
"Какое футуристическое устройство ты хотел(а) бы испытать со мной?",
"Какой наш совместный эксперимент мог бы стать известным?",
"Какое неожиданное признание ты хотел(а) бы мне сделать?",
"Какой наш творческий дуэт мог бы покорить мир?",
"Какое необычное животное мы могли бы завести?",
"Какой фантастический транспорт мы могли бы испытать?",
"Какое нестандартное свидание могло бы нас удивить?",
"Какой наш совместный рекорд мог бы попасть в книгу Гиннесса?"
];

// Элементы DOM
const card = document.getElementById('card');
const cardContent = document.getElementById('card-content');
const nextBtn = document.getElementById('next-btn');
const shareBtn = document.getElementById('share-btn');
const cardStack = document.querySelector('.card-stack');

// Переменные состояния
let currentQuestion = "";
let isDragging = false;
let startX, startY;

// Инициализация стопки карт
function initCardStack() {
    const underCards = document.querySelectorAll('.card-under');
    
    underCards.forEach((card, i) => {
        // Случайные смещения для хаотичности
        const randomX = (Math.random() * 10) - 5;
        const randomY = 8 + (i * 8);
        const randomRot = (Math.random() * 6) - 3;
        
        card.style.transform = `
            translateX(${randomX}px) 
            rotate(${randomRot}deg) 
            translateY(${randomY}px)
        `;
    });
}

// Показ случайного вопроса
function showRandomQuestion() {
    const randomIndex = Math.floor(Math.random() * questions.length);
    currentQuestion = questions[randomIndex];
    cardContent.textContent = currentQuestion;
    
    // Анимация появления
    card.style.transform = 'translate(-50%, -50%)';
    card.classList.add('card-enter');
    
    setTimeout(() => {
        card.classList.remove('card-enter');
        initCardStack(); // Обновляем стопку после смены карты
    }, 300);
}

// Перетаскивание карты (для десктопа)
card.addEventListener('mousedown', (e) => {
    isDragging = true;
    startX = e.clientX;
    startY = e.clientY;
    card.style.transition = 'none';
    card.classList.add('dragging');
});

document.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    
    const x = e.clientX - startX;
    card.style.transform = `
        translate(calc(-50% + ${x}px), -50%) 
        rotate(${x / 20}deg)
    `;
});

document.addEventListener('mouseup', (e) => {
    if (!isDragging) return;
    isDragging = false;
    
    const x = e.clientX - startX;
    if (Math.abs(x) > 100) {
        card.style.transition = 'transform 0.4s ease-out';
        card.style.transform = `
            translate(${x > 0 ? '100%' : '-100%'}, -50%) 
            rotate(${x / 10}deg)
        `;
        setTimeout(showRandomQuestion, 400);
    } else {
        card.style.transition = 'transform 0.3s';
        card.style.transform = 'translate(-50%, -50%)';
    }
    
    card.classList.remove('dragging');
});

// Свайп на мобильных
card.addEventListener('touchstart', (e) => {
    e.preventDefault();
    isDragging = true;
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
    card.style.transition = 'none';
    card.classList.add('dragging');
});

card.addEventListener('touchmove', (e) => {
    if (!isDragging) return;
    e.preventDefault();
    
    const currentX = e.touches[0].clientX;
    const diffX = currentX - startX;
    card.style.transform = `
        translate(calc(-50% + ${diffX}px), -50%) 
        rotate(${diffX / 20}deg)
    `;
});

card.addEventListener('touchend', (e) => {
    if (!isDragging) return;
    isDragging = false;
    e.preventDefault();
    
    const endX = e.changedTouches[0].clientX;
    const diffX = endX - startX;
    
    if (Math.abs(diffX) > 50) {
        card.style.transition = 'transform 0.4s ease-out';
        card.style.transform = `
            translate(${diffX > 0 ? '100%' : '-100%'}, -50%) 
            rotate(${diffX / 10}deg)
        `;
        setTimeout(showRandomQuestion, 400);
    } else {
        card.style.transition = 'transform 0.3s';
        card.style.transform = 'translate(-50%, -50%)';
    }
    
    card.classList.remove('dragging');
});

// Кнопка "Дальше"
nextBtn.addEventListener('click', () => {
    card.style.transition = 'transform 0.4s ease-out';
    card.style.transform = 'translate(-150%, -50%) rotate(-15deg)';
    setTimeout(showRandomQuestion, 400);
});

// Кнопка "Поделиться"
shareBtn.addEventListener('click', async function() {
    const shareBtn = this;
    const originalText = shareBtn.textContent;
    
    try {
        shareBtn.textContent = '...';
        shareBtn.disabled = true;
        
        // Даем время на рендеринг
        await new Promise(resolve => setTimeout(resolve, 300));
        
        // Создаем изображение карточки
        const canvas = await html2canvas(card, {
            scale: 1,
            useCORS: true,
            backgroundColor: null,
            logging: false
        });
        
        // Конвертируем в Blob
        canvas.toBlob(async function(blob) {
            try {
                const text = `${currentQuestion}\n\n(Поделено через Card Love)`;
                
                // Попробуем нативный sharing API
                if (navigator.share) {
                    try {
                        const file = new File([blob], 'cardlove.png', { type: 'image/png' });
                        await navigator.share({
                            files: [file],
                            title: 'Card Love',
                            text: text
                        });
                        return;
                    } catch (e) {
                        console.log('Native share cancelled');
                    }
                }
                
                // Fallback для мобильных устройств
                if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                    window.open(`whatsapp://send?text=${encodeURIComponent(text)}`);
                } 
                // Fallback для десктопа
                else {
                    const url = URL.createObjectURL(blob);
                    const newWindow = window.open();
                    newWindow.document.write(`
                        <img src="${url}" style="max-width:100%;border-radius:10px;margin:20px;">
                        <p style="font-family:Arial;padding:0 20px;">${text}</p>
                    `);
                }
            } catch (err) {
                console.error('Sharing error:', err);
                alert('Скопируйте вопрос:\n\n' + currentQuestion);
            } finally {
                shareBtn.textContent = originalText;
                shareBtn.disabled = false;
            }
        }, 'image/png');
    } catch (err) {
        console.error('Canvas error:', err);
        shareBtn.textContent = 'Ошибка';
        setTimeout(() => {
            shareBtn.textContent = originalText;
            shareBtn.disabled = false;
        }, 2000);
    }
});

// Инициализация при загрузке
document.addEventListener('DOMContentLoaded', () => {
    initCardStack();
    showRandomQuestion();
});